<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull King: √âdition Soren</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíÄ</text></svg>">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../common/style.css">

    <style>
        :root {
            --bg-color: #1a1a1d;
            --table-bg: #252529;
            --gold: #d4af37;
            --gold-dim: #8a7326;
            --gold-dark: #5c4d1a;
            --text: #f0f0f0;
            --btn-bg: #3e3e42;
            --dark-overlay: rgba(0, 0, 0, 0.95);
            --toast-bg-err: #c0392b;
            --toast-bg-info: #2980b9;
        }

        * {
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            font-family: 'Roboto', sans-serif;
        }

        .toast-error {
            background-color: var(--toast-bg-err);
            color: white;
        }

        .toast-info {
            background-color: var(--toast-bg-info);
            color: white;
        }

        .toast-visible {
            transform: translateY(0) !important;
        }

        header {
            background: #000;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--gold);
            height: 60px;
            flex-shrink: 0;
        }

        h1 {
            font-family: 'Pirata One', cursive;
            color: var(--gold);
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: 1px solid #444;
            color: var(--gold);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            font-family: 'Pirata One', cursive;
        }

        #setup-screen {
            padding: 20px;
            overflow-y: auto;
            text-align: center;
            flex: 1;
        }

        .input-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .player-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dealer-radio {
            display: none;
        }

        .dealer-label {
            color: #444;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
            min-width: 25px;
        }

        .dealer-radio:checked+.dealer-label {
            color: var(--gold);
            text-shadow: 0 0 5px var(--gold-dim);
        }

        input[type="text"] {
            flex: 1;
            background: #fdf5e6;
            border: 2px solid var(--gold-dim);
            padding: 12px;
            font-size: 1.1rem;
            border-radius: 4px;
            color: #000;
            font-family: 'Pirata One', cursive;
            text-transform: capitalize;
        }

        .btn-main {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 15px;
            font-size: 1.4rem;
            font-family: 'Pirata One', cursive;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .btn-add-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            opacity: 0.7;
            cursor: pointer;
        }

        .btn-add-row:hover {
            opacity: 1;
        }

        .btn-add-placeholder {
            flex: 1;
            background: transparent;
            border: 2px dashed #555;
            padding: 12px;
            font-size: 1.1rem;
            border-radius: 4px;
            color: #aaa;
            font-family: 'Pirata One', cursive;
            text-align: left;
        }

        #input-zone {
            flex: 0 0 auto;
            background: #222;
            padding: 15px;
            border-bottom: 1px solid var(--gold-dim);
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .wizard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-turn {
            font-family: 'Pirata One', cursive;
            font-size: 2.8rem;
            color: var(--gold);
            line-height: 1;
            text-shadow: 2px 2px 0px #000;
        }

        .instruction {
            font-size: 1.4rem;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
            text-shadow: 1px 1px 2px #000;
            margin-top: 5px;
        }

        .num-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .num-grid::-webkit-scrollbar {
            height: 6px;
        }

        .num-grid::-webkit-scrollbar-track {
            background: #333;
        }

        .num-grid::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 3px;
        }

        .num-btn {
            background: #333;
            color: var(--gold);
            border: 1px solid #444;
            padding: 15px 0;
            font-size: 1.4rem;
            font-family: 'Pirata One', cursive;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s;
            flex: 0 0 60px;
            width: 60px;
        }

        .num-btn:active,
        .num-btn.selected {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
            transform: scale(0.95);
        }

        #summary-list {
            margin-bottom: 15px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 4px;
            background: #1a1a1d;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            font-family: 'Pirata One', cursive;
            font-size: 1.2rem;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-val {
            color: var(--gold);
        }

        .bonus-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            background: #111;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .bonus-btn {
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            border-radius: 50%;
            cursor: pointer;
        }

        #bonus-display {
            font-size: 1.8rem;
            color: var(--gold);
            width: 60px;
            text-align: center;
            font-family: 'Pirata One';
        }

        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-revert {
            background: transparent;
            color: #888;
            width: 60px;
            font-size: 1.2rem;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-confirm {
            flex: 1;
            background: var(--gold);
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            padding: 12px;
            font-size: 1.2rem;
            font-family: 'Pirata One';
        }

        #scoreboard-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            text-align: center;
        }

        th {
            background: #000;
            color: var(--gold);
            position: sticky;
            top: 0;
            padding: 12px 5px;
            z-index: 2;
            font-family: 'Pirata One', cursive;
            font-size: 1.2rem;
            min-width: 80px;
            border-bottom: 1px solid var(--gold-dim);
            border-top: 4px solid transparent;
        }

        th.dealer-frame {
            border: 2px solid var(--gold);
            background: #222;
            position: sticky;
            z-index: 5;
            box-shadow: 0 0 10px var(--gold-dim);
        }

        .dealer-icon {
            font-size: 0.8rem;
            margin-right: 5px;
            color: var(--gold);
            display: none;
        }

        th.dealer-frame .dealer-icon {
            display: inline-block;
        }

        td:first-child,
        th:first-child,
        tfoot td:first-child {
            position: sticky;
            left: 0;
            background: #111;
            z-index: 3;
            border-right: 1px solid #333;
            width: 40px;
        }

        th:first-child {
            z-index: 4;
        }

        tfoot {
            position: sticky;
            bottom: 0;
            background: #000;
            z-index: 5;
            border-top: 2px solid var(--gold);
        }

        tfoot td {
            color: var(--gold);
            font-family: 'Pirata One';
            font-size: 1.4rem;
            background: #000;
            font-weight: bold;
        }

        td {
            padding: 8px 4px;
            border-bottom: 1px solid #333;
            border-right: 1px solid #333;
            height: 55px;
        }

        .cell-score {
            font-size: 1.3rem;
            font-family: 'Pirata One';
            font-weight: bold;
            display: block;
            margin-top: 4px;
        }

        /* CIRCLE VISUALS (v4.4) */
        .visual-score {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
        }

        .box {
            width: 18px;
            height: 18px;
            border: 1px solid var(--gold);
            display: inline-block;
            border-radius: 50%;
            /* Circle */
        }

        .box.filled {
            background-color: var(--gold);
        }

        .box.empty {
            background-color: transparent;
        }

        .box.over {
            position: relative;
        }

        .box.over::after {
            content: '+';
            color: var(--gold);
            font-size: 18px;
            line-height: 16px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: bold;
        }

        .zero-dash {
            display: inline-block;
            font-size: 20px;
            line-height: 18px;
            color: #888;
            font-family: 'Pirata One';
        }

        .active-round {
            background-color: rgba(212, 175, 55, 0.15);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-overlay);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-color);
            border: 2px solid var(--gold);
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: left;
        }

        .modal h2 {
            margin-top: 0;
            color: var(--gold);
            font-family: 'Pirata One';
            text-align: center;
            font-size: 2rem;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #333;
            font-family: 'Pirata One', cursive;
            font-size: 1.5rem;
        }

        .rank-pos {
            width: 30px;
            color: #888;
        }

        .rank-name {
            flex: 1;
            text-align: left;
            padding-left: 10px;
        }

        .rank-score {
            color: var(--gold);
            font-weight: bold;
        }

        .rank-1 .rank-pos {
            color: var(--gold);
            font-size: 1.8rem;
        }

        .rank-1 .rank-name {
            color: var(--gold);
            font-size: 1.8rem;
        }

        .rank-1::after {
            content: 'üèÜ';
            font-size: 1.5rem;
            margin-left: 10px;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .hidden {
            display: none !important;
        }

        .new-game-banner {
            text-align: center;
            padding: 10px;
            background: #222;
            border-bottom: 1px solid var(--gold);
        }
    </style>
</head>

<body>

    <div id="notification-bar"></div>
    <audio id="sfx-player" preload="auto"></audio>

    <header>
        <h1><i class="fas fa-skull-crossbones"></i> Skull King</h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="showRules()"><i class="fas fa-scroll"></i></button>
            <button class="icon-btn" onclick="resetGame()"><i class="fas fa-trash-alt"></i></button>
            <button class="icon-btn" onclick="toggleLanguage()" id="lang-btn">üá¨üáß</button>
        </div>
    </header>

    <div id="rules-modal" class="modal" onclick="closeRules(event)">
        <div class="modal-content">
            <h2 id="modal-head">Bonus & Rules</h2>
            <div id="rules-list"></div>
            <button class="btn-main" onclick="document.getElementById('rules-modal').style.display='none'"
                style="margin-top:20px; padding:10px;">Close</button>
        </div>
    </div>

    <div id="ranking-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div id="ranking-capture-area" style="background-color: var(--bg-color); padding:10px; border-radius:4px;">
                <h2 id="rank-title">Captain's Log</h2>
                <div id="ranking-list"></div>
            </div>

            <div style="display:flex; gap:10px; flex-direction:column; margin-top:20px;">
                <button class="btn-confirm" onclick="shareRanking()"><i class="fas fa-share-alt"></i> Partager</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-revert" style="flex:1; width:auto; border:1px solid #555;"
                        onclick="closeRanking()">Voir Score</button>
                    <button class="btn-main" style="flex:1; margin-top:0;" onclick="resetGame()">Nouveau Jeu</button>
                </div>
            </div>
        </div>
    </div>

    <div id="setup-screen">
        <h2 id="setup-title" style="color:var(--gold); font-family:'Pirata One'; font-size:2rem;">Ship Manifest</h2>
        <div class="input-list" id="player-inputs"></div>

        <div class="input-list" style="margin-top: 10px;">
            <div class="btn-add-row" onclick="addPlayerInput()">
                <div style="width: 25px;"></div>
                <div class="btn-add-placeholder">+ <span id="txt-add">Add Pirate</span></div>
            </div>
        </div>

        <div style="display:none;">
            <input type="checkbox" id="use-soren-rule" checked>
        </div>

        <button class="btn-main" onclick="startGame()" id="btn-start">Set Sail!</button>
        <div id="resume-msg" class="hidden" style="margin-top:10px; color: var(--gold)">Previous game found!</div>
    </div>

    <div id="input-zone">
        <div class="wizard-header">
            <div>
                <div class="player-turn" id="wiz-player">Player</div>
                <div class="instruction" id="wiz-instruction">Enter Bet</div>
            </div>
            <div style="font-size: 1.5rem; font-family:'Pirata One'; color: #888;" id="wiz-round">Round 1</div>
        </div>

        <div id="number-grid" class="num-grid"></div>

        <div id="bonus-section" class="hidden">
            <div class="instruction" style="text-align:center;" id="txt-bonus">Bonus Points</div>
            <div class="bonus-controls">
                <button class="bonus-btn" onclick="adjustBonus(-10)">-</button>
                <span id="bonus-display">0</span>
                <button class="bonus-btn" onclick="adjustBonus(10)">+</button>
            </div>
        </div>

        <div id="score-actions" class="action-row hidden">
            <button class="btn-revert" onclick="revertAction()"><i class="fas fa-undo"></i></button>
            <button class="btn-confirm" onclick="confirmResult()" id="btn-save">Save Results</button>
        </div>

        <div id="confirm-section" class="hidden">
            <div id="summary-list"></div>
            <button class="btn-confirm" onclick="finalizePhase()" style="width:100%"><i class="fas fa-check"></i> <span
                    id="txt-confirm">Confirm</span></button>
            <button class="btn-revert" onclick="revertAction()"
                style="width:100%; margin-top:10px; border:none; color:#666">Go Back</button>
        </div>

        <div id="bet-controls" class="action-row hidden">
            <button class="btn-revert" onclick="revertAction()" style="width: 100%"><i class="fas fa-undo"></i> <span
                    id="txt-undo">Undo</span></button>
        </div>
    </div>

    <div id="scoreboard-container" class="hidden">
        <div id="finished-game-banner" class="new-game-banner hidden">
            <button class="btn-main" onclick="resetGame()" style="margin-top:0; padding:10px;">Start New Game</button>
        </div>
        <table id="score-table">
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
            <tfoot id="table-foot"></tfoot>
        </table>
        <div class="common-footer" style="padding-bottom: 20px;">
            <a href="../index.html" class="btn-home"><i class="fas fa-arrow-left"></i> Accueil</a>
        </div>
    </div>

    <datalist id="player-history"></datalist>

    <script>
        const STORAGE_KEY = 'skullKing_Soren_v44';
        const HISTORY_KEY = 'skullKing_Names';

        const SOUNDS = {
            start: { local: "argh.mp3", backup: "https://archive.org/download/PirateArrr/Pirate%20Arrr.mp3" },
            bet: { local: "sword.mp3", backup: "https://archive.org/download/SwordSwoosh/SwordSwoosh.mp3" },
            score: { local: "coin.mp3", backup: "https://archive.org/download/Coins_201608/Coins.mp3" }
        };

        function showToast(msg, type = 'error') {
            const bar = document.getElementById('notification-bar');
            bar.innerText = msg;
            bar.className = (type === 'error') ? 'toast-error' : 'toast-info';
            bar.classList.add('toast-visible');
            setTimeout(() => { bar.classList.remove('toast-visible'); }, 3000);
        }

        function playSound(type) {
            const audio = document.getElementById('sfx-player');
            const soundConfig = SOUNDS[type];
            if (!soundConfig) return;

            audio.src = soundConfig.local;
            audio.onerror = function () {
                if (audio.src !== soundConfig.backup) {
                    audio.src = soundConfig.backup;
                    audio.play().catch(() => { });
                }
            };
            audio.currentTime = 0;
            audio.volume = 1.0;
            audio.play().catch(() => {
                if (audio.src.indexOf("http") === -1) {
                    audio.src = soundConfig.backup;
                    audio.play();
                }
            });
        }

        let curLang = 'fr';
        const I18N = {
            en: {
                add: "Add Pirate",
                start: "Set Sail!",
                betInstr: "Place bet for",
                resInstr: "Tricks won by",
                bonus: "Bonus Points",
                save: "Save & Next",
                undo: "Undo",
                round: "R",
                roundFull: "Round ",
                total: "Total",
                manifest: "Ship Manifest",
                resetWarn: "Are you sure you want to delete this game and start over?",
                modalHead: "Bonus & Rules",
                betPrefix: "Bet:",
                donePrefix: "Done:",
                impossible: "Impossible! Tricks won cannot exceed round number.",
                noBonusError: "Impossible! You cannot get Bonus Points if you won 0 tricks!",
                roundMathError: "Sum of tricks must equal Round number",
                review: "Review",
                checkBets: "Check Bets",
                checkScores: "Check Scores",
                confirm: "Confirm",
                needPirates: "You need at least 1 pirate to play!",
                selectTricks: "Select tricks won first",
                rankTitle: "Captain's Log",
                rules: [
                    ["Suits", "Yellow, Green, Purple (Low)"],
                    ["Jolly Roger", "Black (High Suit)"],
                    ["Pirate", "Beats all Suits & Jolly Roger"],
                    ["Escape (White Flag)", "Loses (unless all play Escape)"],
                    ["Tigress", "Pirate OR Escape"],
                    ["Skull King", "Beats all Pirates"],
                    ["Mermaid", "Beats Skull King, loses to Pirates"],
                    ["---", "---"],
                    ["Capturing 10, 11, 12, 13", "+10/20 Bonus"],
                    ["Capturing Mermaid", "+20 Bonus"],
                    ["Mermaid captures Skull King", "+40 Bonus"],
                    ["Skull King captures Pirate", "+30 Bonus each"]
                ]
            },
            fr: {
                add: "Ajouter un Pirate",
                start: "Hisser les voiles !",
                betInstr: "Mise pour",
                resInstr: "Plis faits par",
                bonus: "Points Bonus",
                save: "Sauver & Suivant",
                undo: "Retour",
                round: "M",
                roundFull: "Manche ",
                total: "Total",
                manifest: "Manifeste",
                resetWarn: "Voulez-vous vraiment effacer cette partie et recommencer ?",
                modalHead: "R√®gles & Bonus",
                betPrefix: "Pari:",
                donePrefix: "Fait:",
                impossible: "Impossible ! Le total des plis d√©passe la manche.",
                noBonusError: "Impossible ! Pas de Points Bonus avec 0 pli gagn√© !",
                roundMathError: "La somme des plis doit √©galer la manche",
                review: "V√©rification",
                checkBets: "V√©rifier les Paris",
                checkScores: "V√©rifier les Scores",
                confirm: "Confirmer",
                needPirates: "Il faut au moins 1 pirate pour jouer !",
                selectTricks: "S√©lectionnez les plis gagn√©s d'abord",
                rankTitle: "Journal de Bord",
                rules: [
                    ["Couleurs", "Jaune, Vert, Violet (Bas)"],
                    ["Jolly Roger", "Noir (Atout)"],
                    ["Pirate", "Bat toutes couleurs & Jolly Roger"],
                    ["Fuite (Drapeau Blanc)", "Perd (sauf si tout le monde fuit)"],
                    ["Tigresse", "Pirate OU Fuite"],
                    ["Skull King", "Bat tous les Pirates"],
                    ["Sir√®ne", "Bat Skull King, perd contre Pirates"],
                    ["---", "---"],
                    ["Capturer le 14", "+10/20 Bonus"],
                    ["Capturer Sir√®ne", "+20 Bonus"],
                    ["Sir√®ne capture Skull King", "+40 Bonus"],
                    ["Skull King capture Pirate", "+30 Bonus chaque"]
                ]
            }
        };

        function t(key) { return I18N[curLang][key]; }

        function toggleLanguage() {
            curLang = curLang === 'en' ? 'fr' : 'en';
            document.getElementById('lang-btn').innerText = curLang === 'en' ? 'üá´üá∑' : 'üá¨üáß';
            updateUIText();
        }

        function updateUIText() {
            document.getElementById('txt-add').innerText = t('add');
            document.getElementById('btn-start').innerText = t('start');
            document.getElementById('txt-bonus').innerText = t('bonus');
            document.getElementById('btn-save').innerText = t('save');
            document.getElementById('txt-undo').innerText = t('undo');
            document.getElementById('setup-title').innerText = t('manifest');
            document.getElementById('modal-head').innerText = t('modalHead');
            document.getElementById('txt-confirm').innerText = t('confirm');
            document.getElementById('rank-title').innerText = t('rankTitle');

            if (gameState.started) {
                renderWizard();
                renderTableStructure();
                recalculateAllTotals();
            }

            const rulesDiv = document.getElementById('rules-list');
            rulesDiv.innerHTML = '';
            I18N[curLang].rules.forEach(r => {
                const div = document.createElement('div');
                div.className = 'rule-item';
                div.innerHTML = `<span style="color:#aaa">${r[0]}</span><span style="color:var(--gold)">${r[1]}</span>`;
                rulesDiv.appendChild(div);
            });
        }

        let gameState = {
            started: false,
            players: [],
            round: 1,
            maxRounds: 10,
            phase: 'betting',
            activePlayerIdx: 0,
            useSorenRule: true,
            initialDealerIdx: 0,
            tempBonus: 0,
            tempWonValue: null
        };

        function init() {
            populateNameHistory();
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    gameState = JSON.parse(saved);
                    if (gameState.started) {
                        document.getElementById('setup-screen').classList.add('hidden');
                        document.getElementById('input-zone').style.display = 'block';
                        document.getElementById('scoreboard-container').classList.remove('hidden');

                        renderTableStructure();
                        gameState.players.forEach((p, idx) => {
                            p.scores.forEach((s, roundIdx) => updateScoreCell(idx, roundIdx + 1, s));
                        });

                        recalculateAllTotals();
                        renderWizard();

                        if (gameState.round >= gameState.maxRounds && gameState.phase === 'finished') {
                            showRanking();
                            document.getElementById('input-zone').style.display = 'none';
                            document.getElementById('finished-game-banner').classList.remove('hidden');
                        }
                    } else {
                        const container = document.getElementById('player-inputs');
                        container.innerHTML = '';
                        gameState.players.forEach((p, idx) => addPlayerInput(p.name, idx === 0));
                        document.getElementById('resume-msg').classList.remove('hidden');
                    }
                } catch (e) {
                    localStorage.removeItem(STORAGE_KEY);
                    setupNewGame();
                }
            } else {
                setupNewGame();
            }
            updateUIText();
        }

        function recalculateAllTotals() {
            gameState.players.forEach(p => {
                p.totalScore = p.scores.reduce((sum, s) => sum + (Number(s.points) || 0), 0);
            });
            updateTotals();
        }

        function populateNameHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const datalist = document.getElementById('player-history');
            datalist.innerHTML = '';
            history.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
            });
        }

        function saveNameHistory(names) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            names.forEach(n => {
                if (!history.includes(n)) history.push(n);
            });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            populateNameHistory();
        }

        function setupNewGame() {
            const container = document.getElementById('player-inputs');
            container.innerHTML = '';
            for (let i = 0; i < 4; i++) addPlayerInput("", i === 0);
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
        }

        function resetGame() {
            if (confirm(t('resetWarn'))) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function capitalize(str) {
            if (!str) return "";
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function addPlayerInput(val = '', isFirst = false) {
            const container = document.getElementById('player-inputs');
            const div = document.createElement('div');
            div.className = 'player-row';
            const num = container.children.length + 1;

            const radioId = `dealer-radio-${num}`;
            const checked = isFirst ? 'checked' : '';

            div.innerHTML = `
                <input type="radio" name="starting-dealer" id="${radioId}" class="dealer-radio" value="${num - 1}" ${checked}>
                <label for="${radioId}" class="dealer-label" title="Start as Dealer"><i class="fas fa-crown"></i></label>
                <input type="text" class="p-name" placeholder="Pirate ${num}" value="${val}" list="player-history" onblur="this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1)">
            `;
            container.appendChild(div);
        }

        function startGame() {
            const inputs = document.querySelectorAll('.p-name');
            const names = Array.from(inputs).map(i => capitalize(i.value.trim())).filter(n => n !== "");

            if (names.length < 1) return showToast(t('needPirates'));

            const dealerRadio = document.querySelector('input[name="starting-dealer"]:checked');
            const dealerVal = dealerRadio ? parseInt(dealerRadio.value) : 0;
            const dealerIdx = (dealerVal < names.length) ? dealerVal : 0;

            if (!gameState.started || gameState.players.length === 0) {
                gameState.players = names.map(n => ({
                    name: n,
                    scores: [],
                    totalScore: 0
                }));
                gameState.useSorenRule = true;
                gameState.started = true;
                gameState.round = 1;
                gameState.phase = 'betting';
                gameState.activePlayerIdx = 0;
                gameState.initialDealerIdx = dealerIdx;

                saveNameHistory(names);
            }

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('input-zone').style.display = 'block';
            document.getElementById('scoreboard-container').classList.remove('hidden');

            renderTableStructure();
            renderWizard();
            saveState();
            playSound('start');
        }

        function renderWizard() {
            if (gameState.phase === 'finished') return;

            const wizPlayer = document.getElementById('wiz-player');
            const wizInstr = document.getElementById('wiz-instruction');
            const wizRound = document.getElementById('wiz-round');
            const numGrid = document.getElementById('number-grid');
            const bonusSection = document.getElementById('bonus-section');
            const betControls = document.getElementById('bet-controls');
            const scoreActions = document.getElementById('score-actions');
            const confirmSection = document.getElementById('confirm-section');

            if (gameState.activePlayerIdx >= gameState.players.length) {
                wizPlayer.innerText = t('review');
                wizInstr.innerText = (gameState.phase === 'betting') ? t('checkBets') : t('checkScores');
                wizRound.innerText = "";

                numGrid.classList.add('hidden');
                bonusSection.classList.add('hidden');
                betControls.classList.add('hidden');
                scoreActions.classList.add('hidden');
                confirmSection.classList.remove('hidden');

                const list = document.getElementById('summary-list');
                list.innerHTML = '';
                gameState.players.forEach(p => {
                    const data = p.scores[gameState.round - 1] || {};
                    let valDisplay = '';
                    if (gameState.phase === 'betting') valDisplay = `${t('betPrefix')} ${data.bet}`;
                    else valDisplay = `Won: ${data.won} / Pts: ${data.points}`;

                    const item = document.createElement('div');
                    item.className = 'summary-item';
                    item.innerHTML = `<span>${p.name}</span><span class="summary-val">${valDisplay}</span>`;
                    list.appendChild(item);
                });
                return;
            }

            confirmSection.classList.add('hidden');
            const player = gameState.players[gameState.activePlayerIdx];

            wizPlayer.innerText = player.name;
            wizRound.innerText = `${t('roundFull')}${gameState.round}`;

            numGrid.innerHTML = '';
            numGrid.classList.remove('hidden');

            for (let i = 0; i <= gameState.round; i++) {
                const btn = document.createElement('button');
                btn.className = 'num-btn';
                btn.innerText = i;
                if (gameState.tempWonValue === i) btn.classList.add('selected');

                btn.onclick = () => handleNumberClick(i);
                numGrid.appendChild(btn);
            }

            if (gameState.phase === 'betting') {
                wizInstr.innerText = `${t('betInstr')} ${t('roundFull')} ${gameState.round}`;
                bonusSection.classList.add('hidden');
                scoreActions.classList.add('hidden');

                if (gameState.activePlayerIdx > 0) {
                    betControls.classList.remove('hidden');
                } else {
                    betControls.classList.add('hidden');
                }
            } else {
                wizInstr.innerText = `${t('resInstr')} ${player.name}`;
                betControls.classList.add('hidden');
                scoreActions.classList.remove('hidden');

                if (gameState.tempWonValue !== null && gameState.tempWonValue > 0) {
                    bonusSection.classList.remove('hidden');
                } else {
                    bonusSection.classList.add('hidden');
                }

                document.getElementById('bonus-display').innerText = gameState.tempBonus;
            }

            highlightActiveRow();
        }

        function handleNumberClick(val) {
            const player = gameState.players[gameState.activePlayerIdx];

            if (gameState.phase === 'betting') {
                if (!player.scores[gameState.round - 1]) player.scores[gameState.round - 1] = {};
                player.scores[gameState.round - 1].bet = val;

                updateScoreCell(gameState.activePlayerIdx, gameState.round, player.scores[gameState.round - 1]);
                saveState();
                nextStep();
            } else {
                gameState.tempWonValue = val;
                if (val === 0) {
                    gameState.tempBonus = 0;
                    document.getElementById('bonus-section').classList.add('hidden');
                } else {
                    document.getElementById('bonus-section').classList.remove('hidden');
                }
                saveState();

                const btns = document.querySelectorAll('.num-btn');
                btns.forEach(b => {
                    if (parseInt(b.innerText) === val) {
                        b.classList.add('selected');
                    } else {
                        b.classList.remove('selected');
                    }
                });
            }
        }

        function adjustBonus(amount) {
            gameState.tempBonus += amount;
            document.getElementById('bonus-display').innerText = gameState.tempBonus;
            saveState();
        }

        function confirmResult() {
            if (gameState.tempWonValue === null) return showToast(t('selectTricks'));

            let tricksSoFar = 0;
            gameState.players.forEach((p, idx) => {
                if (idx < gameState.activePlayerIdx && p.scores[gameState.round - 1]) {
                    tricksSoFar += (p.scores[gameState.round - 1].won || 0);
                }
            });
            tricksSoFar += gameState.tempWonValue;

            if (tricksSoFar > gameState.round) {
                return showToast(t('impossible') + ` (Current: ${tricksSoFar} vs Round: ${gameState.round})`);
            }

            if (gameState.tempWonValue === 0 && gameState.tempBonus !== 0) {
                showToast(t('noBonusError'));
                gameState.tempBonus = 0;
                document.getElementById('bonus-display').innerText = "0";
                saveState();
                return;
            }

            const player = gameState.players[gameState.activePlayerIdx];
            const roundData = player.scores[gameState.round - 1];

            roundData.won = gameState.tempWonValue;
            roundData.bonus = gameState.tempBonus;

            if (gameState.useSorenRule) {
                roundData.points = calculateSorenScore(gameState.round, roundData.bet, roundData.won, roundData.bonus);
            } else {
                roundData.points = calculateStandardScore(gameState.round, roundData.bet, roundData.won, roundData.bonus);
            }

            recalculateAllTotals();

            updateScoreCell(gameState.activePlayerIdx, gameState.round, roundData);

            gameState.tempWonValue = null;
            gameState.tempBonus = 0;
            saveState();

            nextStep();
        }

        function nextStep() {
            gameState.activePlayerIdx++;
            saveState();
            renderWizard();
        }

        function finalizePhase() {
            if (gameState.phase === 'scoring') {
                let totalWon = 0;
                gameState.players.forEach(p => {
                    const s = p.scores[gameState.round - 1];
                    if (s && s.won !== undefined) totalWon += s.won;
                });

                if (totalWon !== gameState.round) {
                    showToast(`${t('roundMathError')} (${totalWon} / ${gameState.round})`);
                    return;
                }
            }

            gameState.activePlayerIdx = 0;

            if (gameState.phase === 'betting') {
                gameState.phase = 'scoring';
                playSound('bet');
            } else {
                if (gameState.round < gameState.maxRounds) {
                    playSound('score');
                    gameState.round++;
                    gameState.phase = 'betting';
                    renderTableStructure();
                    // Calculate totals on new round start to ensure table is fresh
                    recalculateAllTotals();
                    addTableRow(gameState.round);
                } else {
                    playSound('score');
                    gameState.phase = 'finished';
                    document.getElementById('input-zone').style.display = 'none';
                    document.getElementById('finished-game-banner').classList.remove('hidden');
                    showRanking();
                }
            }
            saveState();
            renderWizard();
        }

        function showRanking() {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';

            recalculateAllTotals();
            const sortedPlayers = [...gameState.players].sort((a, b) => b.totalScore - a.totalScore);

            sortedPlayers.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = `ranking-item rank-${idx + 1}`;
                div.innerHTML = `
                    <div class="rank-pos">${idx + 1}</div>
                    <div class="rank-name">${p.name}</div>
                    <div class="rank-score">${p.totalScore}</div>
                `;
                list.appendChild(div);
            });

            document.getElementById('ranking-modal').style.display = 'flex';
        }

        function closeRanking() {
            document.getElementById('ranking-modal').style.display = 'none';
        }

        async function shareRanking() {
            const target = document.getElementById('ranking-capture-area');
            try {
                const canvas = await html2canvas(target, { backgroundColor: '#1a1a1d', scale: 2 });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'skull-king-ranking.png', { type: 'image/png' });
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'Skull King Results',
                                text: 'Check out the scores from our game!'
                            });
                        } catch (e) { console.log('Share failed', e); }
                    } else {
                        const a = document.createElement('a');
                        a.href = canvas.toDataURL();
                        a.download = 'skull-king-ranking.png';
                        a.click();
                    }
                });
            } catch (e) {
                showToast("Error generating image");
            }
        }

        function revertAction() {
            if (gameState.activePlayerIdx > 0) {
                gameState.activePlayerIdx--;

                if (gameState.phase === 'scoring') {
                    const prevPlayer = gameState.players[gameState.activePlayerIdx];
                    const data = prevPlayer.scores[gameState.round - 1];
                    if (data && data.won !== undefined) {
                        gameState.tempWonValue = data.won;
                        gameState.tempBonus = data.bonus;
                    }
                }
                saveState();
                renderWizard();
            }
        }

        function calculateSorenScore(round, bet, won, bonus) {
            const potential = round * 10;
            const diff = Math.abs(bet - won);
            let baseScore = 0;

            if (diff === 0) baseScore = potential;
            else if (diff === 1) baseScore = potential / 2;
            else baseScore = 0;

            return baseScore + bonus;
        }

        function calculateStandardScore(round, bet, won, bonus) {
            if (bet === 0) {
                if (won === 0) return (round * 10) + bonus;
                return (round * -10) + bonus;
            }
            if (bet === won) return (bet * 20) + bonus;
            return (Math.abs(bet - won) * -10) + bonus;
        }

        function renderTableStructure() {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            const tfoot = document.getElementById('table-foot');

            let htmlHead = `<tr><th>${t('round')}</th>`;
            let htmlFoot = `<tr><td>${t('total')}</td>`;

            const leaderIdx = (gameState.round - 1 + gameState.initialDealerIdx) % gameState.players.length;

            gameState.players.forEach((p, idx) => {
                const isLeader = (idx === leaderIdx) ? 'dealer-frame' : '';
                htmlHead += `<th class="${isLeader}"><span class="dealer-icon"><i class="fas fa-crown"></i></span>${p.name.substring(0, 8)}</th>`;
                // BUG FIX: Inject Current Total directly instead of waiting for update
                htmlFoot += `<td id="total-p${idx}">${p.totalScore || 0}</td>`;
            });
            htmlHead += `</tr>`;
            htmlFoot += `</tr>`;

            thead.innerHTML = htmlHead;
            tfoot.innerHTML = htmlFoot;

            tbody.innerHTML = '';
            for (let r = 1; r <= gameState.round; r++) {
                addTableRow(r);
            }
            gameState.players.forEach((p, idx) => {
                p.scores.forEach((s, rIdx) => {
                    if (rIdx < gameState.round) updateScoreCell(idx, rIdx + 1, s);
                });
            });
        }

        function addTableRow(roundNum) {
            const tbody = document.getElementById('table-body');
            if (document.getElementById(`row-r${roundNum}`)) return;

            const tr = document.createElement('tr');
            tr.id = `row-r${roundNum}`;

            let html = `<td>${roundNum}</td>`;
            gameState.players.forEach((p, idx) => {
                html += `<td id="cell-r${roundNum}-p${idx}">
                    <span class="cell-bet"></span>
                    <span class="cell-score"></span>
                </td>`;
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);

            const container = document.getElementById('scoreboard-container');
            container.scrollTop = container.scrollHeight;
        }

        function generateVisuals(bet, won) {
            if (bet === 0) {
                let html = '<div class="visual-score">';
                if (won > 0) {
                    for (let i = 0; i < won; i++) html += '<div class="box over"></div>';
                } else {
                    html += '<span class="zero-dash">-</span>';
                }
                html += '</div>';
                return html;
            }

            let html = '<div class="visual-score">';
            const count = Math.max(bet, (won || 0));

            for (let i = 0; i < count; i++) {
                if (won === undefined || won === null) {
                    html += '<div class="box empty"></div>';
                } else {
                    if (i < bet && i < won) {
                        html += '<div class="box filled"></div>';
                    } else if (i < bet && i >= won) {
                        html += '<div class="box empty"></div>';
                    } else if (i >= bet && i < won) {
                        html += '<div class="box over"></div>';
                    }
                }
            }
            html += '</div>';
            return html;
        }

        function updateScoreCell(pIdx, rIdx, data) {
            const cell = document.getElementById(`cell-r${rIdx}-p${pIdx}`);
            if (!cell) return;

            let visualHTML = '';
            if (data.bet !== undefined && data.bet !== null) {
                visualHTML = generateVisuals(data.bet, data.won);
            }

            const scoreDisplay = (data.points !== undefined) ? data.points : '';

            let color = '#fff';
            if (data.points !== undefined) {
                if (data.points >= 0) {
                    if (data.won !== undefined && data.bet === data.won) {
                        color = 'var(--gold)';
                    } else {
                        color = 'var(--gold-dim)';
                    }
                } else {
                    color = '#888';
                }
            }

            cell.innerHTML = `
                ${visualHTML}
                <span class="cell-score" style="color:${color}">${scoreDisplay}</span>
            `;
        }

        function updateTotals() {
            gameState.players.forEach((p, idx) => {
                const cell = document.getElementById(`total-p${idx}`);
                if (cell) cell.innerText = p.totalScore;
            });
        }

        function highlightActiveRow() {
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('active-round'));
            const row = document.getElementById(`row-r${gameState.round}`);
            if (row) row.classList.add('active-round');
        }

        function showRules() {
            document.getElementById('rules-modal').style.display = 'flex';
        }
        function closeRules(e) {
            if (e.target.id === 'rules-modal') e.target.style.display = 'none';
        }

        window.onload = init;

    </script>
</body>

</html>