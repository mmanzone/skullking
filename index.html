<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skull King: Captain's Log</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #1a1a1d;
            --table-bg: #252529;
            --gold-bright: #ffd700;
            --gold-main: #d4af37;
            --gold-dark: #8a6d3b; 
            --gold-faint: rgba(212, 175, 55, 0.15);
            --text: #f0f0f0;
            --parchment: #fdf5e6;
            --btn-bg: #3e3e42;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0; padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: #000;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--gold-main);
            height: 60px;
            flex-shrink: 0;
        }

        h1 {
            font-family: 'Pirata One', cursive;
            color: var(--gold-main);
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--gold-main);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .lang-toggle {
            font-size: 1.5rem; /* Flag size */
        }

        /* --- Main Layout --- */
        .app-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Setup Screen --- */
        #setup-screen {
            padding: 20px;
            overflow-y: auto;
            text-align: center;
        }

        .input-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        input[type="text"] {
            background: var(--parchment);
            border: 2px solid var(--gold-dark);
            padding: 12px;
            font-size: 1.1rem;
            border-radius: 4px;
            color: #2c2c30;
            font-weight: bold;
            font-family: 'Pirata One', cursive;
        }

        .btn-main {
            background: var(--gold-main);
            color: #000;
            border: 2px solid var(--gold-bright);
            padding: 15px;
            font-size: 1.4rem;
            font-family: 'Pirata One', cursive;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .btn-add {
            background: #2c2c30;
            color: var(--gold-main);
            padding: 10px;
            border: 1px dashed var(--gold-dark);
            margin-top: 5px;
            cursor: pointer;
            font-family: 'Pirata One', cursive;
            font-size: 1.1rem;
        }

        .rules-link {
            display: inline-block;
            margin-top: 20px;
            color: var(--gold-main);
            text-decoration: underline;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* --- Input Area (The Wizard) --- */
        #input-zone {
            flex: 0 0 auto;
            background: #222;
            padding: 15px;
            border-bottom: 2px solid var(--gold-dark);
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.7);
            z-index: 10;
        }

        .wizard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        /* Larger Player Name as requested */
        .player-turn {
            font-family: 'Pirata One', cursive;
            font-size: 2.5rem; 
            color: var(--gold-bright);
            line-height: 1;
            text-shadow: 2px 2px 0px #000;
        }

        .instruction { font-size: 1rem; color: #aaa; margin-top: 5px; }

        .round-badge {
            font-size: 2rem;
            font-family: 'Pirata One';
            color: var(--gold-main);
            border: 2px solid var(--gold-dark);
            border-radius: 50%;
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            background: #000;
        }

        /* Numeric Grid */
        .num-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .num-btn {
            background: var(--btn-bg);
            color: var(--gold-main);
            border: 1px solid var(--gold-dark);
            padding: 15px 0;
            font-size: 1.4rem;
            font-family: 'Pirata One', cursive;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .num-btn:active, .num-btn.selected { 
            background: var(--gold-main); 
            color: black; 
            border-color: var(--gold-bright);
            transform: scale(0.95); 
        }

        /* Bonus Input Specifics */
        .bonus-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            background: #111;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .bonus-btn {
            width: 45px; height: 45px;
            font-size: 1.5rem;
            border: 2px solid var(--gold-dark); 
            background: #222; 
            color: var(--gold-main); 
            border-radius: 50%;
            cursor: pointer;
        }
        #bonus-display { font-size: 1.8rem; color: var(--gold-bright); width: 60px; text-align: center; font-family: 'Pirata One';}

        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Theme: Shades of Gold/Yellow */
        .btn-revert {
            background: #3d3118; /* Very dark gold/brown */
            color: var(--gold-main);
            border: 1px solid var(--gold-dark);
            width: 60px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-confirm {
            flex: 1;
            background: var(--gold-main); /* Main Gold */
            color: #1a1a1d; /* Dark text */
            font-weight: bold;
            border: 1px solid var(--gold-bright); 
            border-radius: 4px;
            padding: 12px;
            font-size: 1.3rem;
            font-family: 'Pirata One', cursive;
            cursor: pointer;
        }

        /* --- Scoreboard Table --- */
        #scoreboard-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            text-align: center;
        }

        th {
            background: #000;
            color: var(--gold-main);
            position: sticky;
            top: 0;
            padding: 10px 5px;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            font-family: 'Pirata One', cursive;
            font-size: 1.2rem;
            min-width: 80px;
        }

        td:first-child, th:first-child {
            position: sticky;
            left: 0;
            background: #111;
            z-index: 3;
            border-right: 1px solid #333;
            width: 40px;
            font-family: 'Pirata One';
            font-size: 1.1rem;
            color: #666;
        }
        th:first-child { z-index: 4; color: var(--gold-main); }

        td {
            padding: 8px 4px;
            border-bottom: 1px solid #333;
            border-right: 1px solid #333;
            height: 60px;
        }

        .cell-bet { font-size: 0.9rem; color: #888; display: block; margin-bottom: 2px;}
        .cell-score { font-size: 1.2rem; font-weight: bold; display: block;}
        
        .active-round { background-color: var(--gold-faint); }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <audio id="pirate-sound" src="https://www.myinstants.com/media/sounds/pirate-arr.mp3" preload="auto"></audio>

    <header>
        <h1><i class="fas fa-skull"></i> Skull King</h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="hardReset()" title="Reset Game">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button class="icon-btn" onclick="openRules()" title="Rules & Bonuses">
                <i class="fas fa-book-open"></i>
            </button>
            <button class="icon-btn lang-toggle" onclick="toggleLanguage()" id="lang-btn">ðŸ‡«ðŸ‡·</button>
        </div>
    </header>

    <div class="app-body">
        
        <div id="setup-screen">
            <h2 id="setup-title" style="font-family:'Pirata One'; font-size:2rem; color:var(--gold-main)">Ship Manifest</h2>
            
            <div class="input-list" id="player-inputs">
                </div>
            
            <button class="btn-add" onclick="addPlayerInput()">+ <span id="txt-add">Add Pirate</span></button>
            
            <div style="margin-top: 20px; text-align: left; background: #222; padding: 15px; border-radius: 4px; border:1px solid #444;">
                <label style="display:flex; align-items:center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="use-soren-rule" checked style="width:20px; height:20px;">
                    <span id="txt-rule" style="color:var(--gold-main)">Use Soren's Scoring Rule</span>
                </label>
                <small style="color:#888; display:block; margin-top:5px; font-style:italic;" id="txt-rule-desc">
                    Success: Round x 10. <br>Off by 1: Half points. <br>Off by 2+: Zero.
                </small>
            </div>

            <button class="btn-main" onclick="startGame()" id="btn-start">Set Sail!</button>
        </div>

        <div id="input-zone">
            <div class="wizard-header">
                <div>
                    <div class="player-turn" id="wiz-player">Name</div>
                    <div class="instruction" id="wiz-instruction">Enter Bet</div>
                </div>
                <div class="round-badge" id="wiz-round">R1</div>
            </div>

            <div id="number-grid" class="num-grid"></div>

            <div id="bonus-section" class="hidden">
                <div class="instruction" style="text-align:center;" id="txt-bonus">Bonus Points</div>
                <div class="bonus-controls">
                    <button class="bonus-btn" onclick="adjustBonus(-10)">-</button>
                    <span id="bonus-display">0</span>
                    <button class="bonus-btn" onclick="adjustBonus(10)">+</button>
                </div>
                
                <div class="action-row">
                    <button class="btn-revert" onclick="revertAction()"><i class="fas fa-undo"></i></button>
                    <button class="btn-confirm" onclick="confirmResult()" id="btn-save">Save Results</button>
                </div>
            </div>
            
            <div id="bet-controls" class="action-row hidden">
                 <button class="btn-revert" onclick="revertAction()" style="width: 100%"><i class="fas fa-undo"></i></button>
            </div>
        </div>

        <div id="scoreboard-container" class="hidden">
            <table id="score-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        /* --- Audio Manager --- */
        // We use an MP3 for the pirate scream as requested.
        // It triggers only on specific events.
        function playPirateSound() {
            const audio = document.getElementById('pirate-sound');
            // Try/Catch to handle browser autoplay policies
            try {
                audio.currentTime = 0;
                audio.volume = 0.5;
                audio.play();
            } catch (e) {
                console.log("Audio play blocked until user interaction");
            }
        }

        /* --- Localization --- */
        let curLang = 'en'; // Default
        const I18N = {
            en: {
                add: "Add Pirate",
                start: "Set Sail!",
                rule: "Use Soren's Scoring Rule",
                ruleDesc: "Success: Round x 10. Off by 1: Half pts. Off by 2+: Zero.",
                betInstr: "Place bet for",
                resInstr: "Tricks won by",
                bonus: "Bonus Points",
                save: "Save & Next",
                round: "Round",
                manifest: "Ship Manifest",
                resetWarn: "Are you sure you want to scuttle the ship? All scores will be lost forever!",
                bonusLink: "https://www.grandpabecksgames.com/products/skull-king" // Fallback link
            },
            fr: {
                add: "Ajouter un Pirate",
                start: "Hisser les voiles !",
                rule: "RÃ¨gle de Soren",
                ruleDesc: "SuccÃ¨s : Manche x 10. Ã‰cart de 1 : MoitiÃ© pts. Ã‰cart 2+ : ZÃ©ro.",
                betInstr: "Mise pour",
                resInstr: "Plis faits par",
                bonus: "Points Bonus",
                save: "Sauver & Suivant",
                round: "Manche",
                manifest: "Manifeste",
                resetWarn: "Voulez-vous vraiment saborder le navire ? Tous les scores seront perdus !",
                bonusLink: "https://www.grandpabecksgames.com/products/skull-king"
            }
        };

        function t(key) { return I18N[curLang][key]; }

        function toggleLanguage() {
            // Logic Inversion: If currently EN, we want to go FR, so button should show Flag of destination (FR)
            // Wait, standard UI is usually "Flag represents Current Language". 
            // User request: "If interface is in French, display UK flag."
            
            curLang = curLang === 'en' ? 'fr' : 'en';
            
            // Button Update
            const btn = document.getElementById('lang-btn');
            // If new lang is EN, show French flag (to switch back). If new is FR, show UK flag.
            btn.innerText = curLang === 'en' ? 'ðŸ‡«ðŸ‡·' : 'ðŸ‡¬ðŸ‡§';
            
            updateUIText();
        }

        function updateUIText() {
            document.getElementById('txt-add').innerText = t('add');
            document.getElementById('btn-start').innerText = t('start');
            document.getElementById('txt-rule').innerText = t('rule');
            document.getElementById('txt-rule-desc').innerHTML = t('ruleDesc');
            document.getElementById('txt-bonus').innerText = t('bonus');
            document.getElementById('btn-save').innerText = t('save');
            document.getElementById('setup-title').innerText = t('manifest');
            if(gameState.started) renderWizard();
        }

        function openRules() {
            // Opens a reliable source for rules in new tab
            const url = "https://cdn.shopify.com/s/files/1/0015/2602/files/Skull_King_Rules_2021.pdf?v=1632850682";
            if(confirm(curLang === 'en' ? "Open Official Rules in new tab?" : "Ouvrir les rÃ¨gles officielles ?")) {
                window.open(url, '_blank');
            }
        }

        /* --- Game State & Storage --- */
        let gameState = {
            started: false,
            players: [],
            round: 1,
            maxRounds: 10,
            phase: 'betting', 
            activePlayerIdx: 0,
            useSorenRule: true,
            tempBonus: 0
        };

        function saveGame() {
            localStorage.setItem('skullKingState_v2', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('skullKingState_v2');
            if (saved) {
                gameState = JSON.parse(saved);
                if (gameState.started) {
                    document.getElementById('setup-screen').classList.add('hidden');
                    document.getElementById('input-zone').style.display = 'block';
                    document.getElementById('scoreboard-container').classList.remove('hidden');
                    renderTableStructure();
                    restoreTableData();
                    renderWizard();
                }
            } else {
                initSetup();
            }
            // Set flag correctly on load based on default EN
            document.getElementById('lang-btn').innerText = 'ðŸ‡«ðŸ‡·';
        }

        function hardReset() {
            if(confirm(t('resetWarn'))) {
                localStorage.removeItem('skullKingState_v2');
                location.reload();
            }
        }

        /* --- Initialization --- */
        function initSetup() {
            const container = document.getElementById('player-inputs');
            container.innerHTML = '';
            for(let i=0; i<4; i++) addPlayerInput();
        }

        function addPlayerInput() {
            const div = document.createElement('div');
            const num = document.getElementById('player-inputs').children.length + 1;
            div.innerHTML = `<input type="text" class="p-name" placeholder="Pirate ${num}">`;
            document.getElementById('player-inputs').appendChild(div);
        }

        function startGame() {
            const inputs = document.querySelectorAll('.p-name');
            const names = Array.from(inputs).map(i => i.value.trim()).filter(n => n !== "");
            
            if(names.length < 1) return alert("Need pirates!");

            gameState.players = names.map(n => ({
                name: n,
                scores: [], 
                totalScore: 0
            }));

            gameState.useSorenRule = document.getElementById('use-soren-rule').checked;
            gameState.started = true;
            gameState.round = 1;
            gameState.phase = 'betting';
            gameState.activePlayerIdx = 0;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('input-zone').style.display = 'block';
            document.getElementById('scoreboard-container').classList.remove('hidden');

            renderTableStructure();
            renderWizard();
            playPirateSound(); // Sound 1: Game Start
            saveGame();
        }

        /* --- Wizard Logic --- */
        let tempWonValue = null;

        function renderWizard() {
            const player = gameState.players[gameState.activePlayerIdx];
            const wizPlayer = document.getElementById('wiz-player');
            const wizInstr = document.getElementById('wiz-instruction');
            const wizRound = document.getElementById('wiz-round');
            const numGrid = document.getElementById('number-grid');
            const bonusSection = document.getElementById('bonus-section');
            const betControls = document.getElementById('bet-controls');

            wizPlayer.innerText = player.name;
            wizRound.innerText = `${t('round')}${gameState.round}`;

            numGrid.innerHTML = '';

            // Buttons 0 to Round#
            for(let i=0; i <= gameState.round; i++) {
                const btn = document.createElement('button');
                btn.className = 'num-btn';
                btn.innerText = i;
                btn.onclick = () => handleNumberClick(i, btn);
                numGrid.appendChild(btn);
            }

            if (gameState.phase === 'betting') {
                wizInstr.innerText = `${t('betInstr')} ${t('round')} ${gameState.round}`;
                bonusSection.classList.add('hidden');
                numGrid.classList.remove('hidden');
                
                if(gameState.activePlayerIdx > 0 || gameState.round > 1) {
                    betControls.classList.remove('hidden');
                } else {
                    betControls.classList.add('hidden');
                }
            } else {
                // Scoring Phase
                wizInstr.innerText = `${t('resInstr')} ${player.name}`;
                betControls.classList.add('hidden');
                bonusSection.classList.remove('hidden'); 
                
                // Reset temporary bonus view
                gameState.tempBonus = 0;
                document.getElementById('bonus-display').innerText = "0";
                tempWonValue = null;
            }
            
            highlightActiveRow();
        }

        function handleNumberClick(val, btnElem) {
            const player = gameState.players[gameState.activePlayerIdx];

            if (gameState.phase === 'betting') {
                if(!player.scores[gameState.round-1]) player.scores[gameState.round-1] = {};
                player.scores[gameState.round-1].bet = val;
                saveGame();
                nextStep(); // Betting is instant
            } else {
                // Scoring Phase: Select won tricks, wait for save
                tempWonValue = val;
                
                document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));
                btnElem.classList.add('selected');
            }
        }

        function adjustBonus(amount) {
            gameState.tempBonus += amount;
            document.getElementById('bonus-display').innerText = gameState.tempBonus;
        }

        function confirmResult() {
            if (tempWonValue === null) return alert("Select tricks won first");
            
            const player = gameState.players[gameState.activePlayerIdx];
            const roundData = player.scores[gameState.round-1];
            
            roundData.won = tempWonValue;
            roundData.bonus = gameState.tempBonus;
            
            if (gameState.useSorenRule) {
                roundData.points = calculateSorenScore(gameState.round, roundData.bet, roundData.won, roundData.bonus);
            } else {
                roundData.points = calculateStandardScore(gameState.round, roundData.bet, roundData.won, roundData.bonus);
            }

            player.totalScore += roundData.points;
            
            updateScoreboardValues();
            saveGame();
            nextStep();
        }

        function nextStep() {
            gameState.activePlayerIdx++;

            // Check if we cycled through all players
            if(gameState.activePlayerIdx >= gameState.players.length) {
                gameState.activePlayerIdx = 0; // Reset to first player
                
                if (gameState.phase === 'betting') {
                    playPirateSound(); // Sound 2: All bets are in
                    gameState.phase = 'scoring';
                    // We stay on Round X, but change phase
                } else {
                    playPirateSound(); // Sound 3: All scores are in
                    
                    if (gameState.round < gameState.maxRounds) {
                        gameState.round++;
                        gameState.phase = 'betting';
                        addTableRow(gameState.round);
                    } else {
                        alert("Game Over! The Captain has spoken.");
                        document.getElementById('input-zone').style.display = 'none';
                    }
                }
            }
            saveGame();
            renderWizard();
        }

        function revertAction() {
            if (gameState.activePlayerIdx > 0) {
                gameState.activePlayerIdx--;
                renderWizard();
            } else {
                // Logic to jump back phase if needed, but for now restricted to current phase loop
                // for data safety.
            }
        }

        /* --- Logic Engines --- */
        function calculateSorenScore(round, bet, won, bonus) {
            const potential = round * 10;
            const diff = Math.abs(bet - won);
            let baseScore = 0;
            if (diff === 0) baseScore = potential;
            else if (diff === 1) baseScore = potential / 2;
            else baseScore = 0; 
            return baseScore + bonus;
        }

        function calculateStandardScore(round, bet, won, bonus) {
            if (bet === 0) return (won === 0) ? (round * 10) + bonus : (round * -10) + bonus;
            if (bet === won) return (bet * 20) + bonus;
            return (Math.abs(bet - won) * -10) + bonus; 
        }

        /* --- Table Renderer --- */
        function renderTableStructure() {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            let htmlHead = `<tr><th>${t('round')}</th>`;
            gameState.players.forEach(p => htmlHead += `<th>${p.name}</th>`);
            htmlHead += `</tr>`;
            thead.innerHTML = htmlHead;
            tbody.innerHTML = '';
            
            // If reloading game, render all previous rows
            for(let r=1; r <= gameState.round; r++) {
                addTableRow(r);
            }
        }

        function addTableRow(roundNum) {
            if(document.getElementById(`row-r${roundNum}`)) return; // Don't duplicate
            
            const tbody = document.getElementById('table-body');
            const tr = document.createElement('tr');
            tr.id = `row-r${roundNum}`;
            let html = `<td>${roundNum}</td>`;
            gameState.players.forEach((p, idx) => {
                html += `<td id="cell-r${roundNum}-p${idx}"><span class="cell-bet">-</span><span class="cell-score"></span></td>`;
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);
            
            setTimeout(() => {
                const c = document.getElementById('scoreboard-container');
                c.scrollTop = c.scrollHeight;
            }, 100);
        }

        function updateScoreboardValues() {
            gameState.players.forEach((p, pIdx) => {
                p.scores.forEach((s, rIdx) => {
                    const roundNum = rIdx + 1;
                    const cell = document.getElementById(`cell-r${roundNum}-p${pIdx}`);
                    if(cell) {
                        const betDisplay = (s.bet !== undefined) ? `Bet: ${s.bet}` : '-';
                        const scoreDisplay = (s.points !== undefined) ? s.points : '';
                        let color = '#fff';
                        if(s.points > 0) color = 'var(--gold-main)';
                        if(s.points === 0) color = '#777';
                        if(s.points < 0) color = '#d9534f';
                        
                        cell.innerHTML = `<span class="cell-bet">${betDisplay}</span><span class="cell-score" style="color:${color}">${scoreDisplay}</span>`;
                    }
                });
            });
        }
        
        function restoreTableData() {
            updateScoreboardValues();
        }

        function highlightActiveRow() {
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('active-round'));
            const row = document.getElementById(`row-r${gameState.round}`);
            if(row) row.classList.add('active-round');
        }

        // Boot
        window.onload = loadGame;

    </script>
</body>
</html>
